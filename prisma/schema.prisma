// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ENUMS
*/
enum ProjectStatus {
  DRAFT
  ACTIVE
}

enum SurveyStatus {
  COLLECTED_PAYMENT
  ERRORED_PAYMENT
}

enum Platform {
  KICKSTARTER
  INDIEGOGO
  UNKNOWN
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

/**
 * MODELS
*/
model Session {
  id            String    @id
  shop          String    @unique
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  backers       Backer[]
}

model Project {
    id              Int             @id @default(autoincrement())
    shop            String
    name            String
    status          ProjectStatus   @default(DRAFT)
    image           String?
    description     String?
    createdBy       String?
    message         String?
    firmness        String?
    label           String?
    question        String?
    addonsHeading   String?
    popupStatus     Boolean         @default(false)
    popupTitle      String?
    popupContent    String?

    uploads         CsvUpload[]
    products        Product[]
    pledges         Pledge[]
    surveys         Survey[]

    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
}

model Backer {
  id        Int      @id @default(autoincrement())
  shop      String
  session   Session  @relation(fields: [shop], references: [shop], onDelete: Cascade)
  email     String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  surveys   Survey[]

  @@unique([shop, email])
  @@index([shop])
}

model Product {
  id          Int         @id @default(autoincrement())
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   Int
  handle      String?
  name        String
  inventories Inventory[]

  @@unique([projectId, name])
  @@index([projectId])
}

model Pledge {
  id        Int      @id @default(autoincrement())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId Int
  pledgeId  String   // From CSV (e.g., "Reward ID" or "Perk ID")
  name      String
  surveys   Survey[]

  @@unique([projectId, pledgeId])
  @@index([projectId])
}

model Survey {
  id           Int          @id @default(autoincrement())
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId    Int
  backer       Backer       @relation(fields: [backerId], references: [id], onDelete: Cascade)
  backerId     Int
  pledge       Pledge       @relation(fields: [pledgeId], references: [id])
  pledgeId     Int
  platform     Platform     @default(UNKNOWN)
  bonusSupport Float        @default(0)
  price        Float
  country      String
  status       SurveyStatus
  inventories  Inventory[]
  purchased    Boolean      @default(false)
  lastSent     Int?

  @@unique([projectId, backerId])
  @@index([projectId])
  @@index([backerId])
}

model Inventory {
  id        Int     @id @default(autoincrement())
  survey    Survey  @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  surveyId  Int
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  qty       Int

  @@unique([surveyId, productId])
}

model CsvUpload {
  id              Int              @id @default(autoincrement())
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       Int
  status          UploadStatus     @default(PENDING)
  totalChunks     Int
  processedChunks Int              @default(0)
  createdAt       DateTime         @default(now())
  completedAt     DateTime?
  chunks          CsvUploadChunk[]
}

model CsvUploadChunk {
  id          Int          @id @default(autoincrement())
  upload      CsvUpload    @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  uploadId    Int
  status      UploadStatus @default(PENDING)
  data        Json
  errors      Json?
  createdAt   DateTime     @default(now())
  processedAt DateTime?
}